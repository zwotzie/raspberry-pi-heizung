<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Heizung hier!</title>
	<!-- Load plotly.js into the DOM -->
	<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
</head>
<body>
<h1>Super Heizung hier ;)</h1>
<div id='Pufferspeicher' style="height: 500px;"><!-- Plotly chart will/should be drawn inside this DIV-->    </div>
<div id='Solar' style="height: 500px;"><!-- Plotly chart will/should be drawn inside this DIV-->    </div>
<div id='Heizung' style="height: 500px;"><!-- Plotly chart will/should be drawn inside this DIV-->    </div>
<div id='Wärmeerzeuger' style="height: 500px;"><!-- Plotly chart will/should be drawn inside this DIV-->    </div>

<script>
keys_analog = ['Zeit', 'RL Kessel', 'Drehzahl Ladepumpe Kessel', 'Kessel Betriebstemperatur', 'Speicherladeleitung',
 'Außentemperatur', 'Raum RASPT', 'Speicher 1 Kopf', 'Speicher 2 Oben', 'Speicher 3 Unten', 'Speicher 4 Mitte',
 'Speicher 5 Boden', 'VL Heizung', 'RL Heizung', 'Drehzahl Heizungspumpe', 'Solarstrahlung', 'VL Solar', 'Drehzahl Ladepumpe Solar'];

keys_digital = ['Heizung: Pumpe', 'Kessel: Ladepumpe', 'Kessel: Freigabe', 'Hz Mischer auf', 'Hz Mischer zu',
 'Kessel Mischer auf', 'Kessel Mischer zu', 'Solarkreispumpe', 'Solar: Ladepumpe', 'Solar: Freigabeventil'];

keys_all = keys_analog.concat(keys_digital);
graphs = {
    'Pufferspeicher': ['Außentemperatur', 'Raum RASPT', 'Speicher 1 Kopf', 'Speicher 2 Oben', 'Speicher 3 Unten', 'Speicher 4 Mitte', 'Speicher 5 Boden'],
    'Solar': ['Außentemperatur', 'Solarstrahlung', 'VL Solar', 'Drehzahl Ladepumpe Solar'],
    'Heizung': ['VL Heizung', 'RL Heizung', 'Drehzahl Heizungspumpe'],
    'Wärmeerzeuger': ['RL Kessel', 'Drehzahl Ladepumpe Kessel', 'Kessel Betriebstemperatur', 'Speicherladeleitung']
}

function toDate(unixtimestamp) {
    ds = new Date(unixtimestamp * 1000 - tz_offset).toISOString();
    return ds
}

var date = new Date();
const tz_offset = date.getTimezoneOffset() * 60000;
const today = toDate(date.getTime()/1000).split('T')[0]

// id = 4 holt alles
var jsonUrl = "http://kleinsthof.de/uvr1611/analogChart.php?date=" + today + "&id=4&period=day";
Plotly.d3.json(jsonUrl, function(err, data) {
//data = JSON.parse(data_json_str);
/*
console.log("data_json (string)" + data_json_str);
console.log("data: " + data);
console.log("data.length: " + data.length);
*/

df = {};
for (var i=0; i < (data[0].length); i++) {
        df[keys_all[i]] = [];
}


for (var i=0; i < data.length; i++) {
    row = data[i];
    for (var k=0; k < (row.length); k++) {
        if (k == 0) {
            df[keys_all[k]].push( toDate(row[k]) );
        }else{
            df[keys_all[k]].push( row[k] );
        }
    }
}

for (const [key, value] of Object.entries(graphs)) {
    plot=[]

    value.forEach(function(entry){
      if (entry != 'Zeit') {
      add = {  type: "scatter",
          mode: "lines",
          name: entry,
          x: df['Zeit'],
          y: df[entry]
          }
      plot.push(add);
      }
    });

    var layout = {
      title: key,
      showlegend: true,
    };

    Plotly.newPlot(key, plot, layout);
}

});
</script>
</body>
</html>
